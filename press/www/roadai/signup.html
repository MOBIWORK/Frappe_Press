{%- extends "templates/eov_signup_layout.html" -%} {%- block content -%}

<div class="flex w-full justify-center items-center text-center my-10" style="align-items: center;">
    <svg width="36" height="37" viewBox="0 0 36 37" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_433_3347)">
        <path d="M0 4.82C0 2.444 1.944 0.5 4.32 0.5H31.68C34.056 0.5 36 2.444 36 4.82V32.18C36 34.556 34.056 36.5 31.68 36.5H4.32C1.944 36.5 0 34.556 0 32.18V4.82Z" fill="url(#paint0_linear_433_3347)"/>
        <g clip-path="url(#clip1_433_3347)">
        <path d="M29.9998 11.077V23.6638L25.749 25.7533L23.4053 26.907L17.3105 29.9027V26.699L23.4053 23.7034L25.749 22.5497V15.7512L23.4053 16.9V21.3167L17.3105 24.3174V17.3159L23.4053 14.3202V11.6662L17.3105 14.6619L14.9783 15.8107V27.8478L12.3129 29.155V14.3846L14.9783 13.0774L17.3105 11.9287L23.4053 8.92805L25.749 7.7793V13.1665L29.9998 11.077Z" fill="white"/>
        <path d="M17.3104 5.90234V9.66054L14.9782 10.8093L12.3128 12.1214L9.7336 13.3841V22.886L5.99976 24.7231V11.4629L9.7336 9.62588L12.3128 8.3583L14.9782 7.0511L17.3104 5.90234Z" fill="white"/>
        <path opacity="0.6" d="M23.4053 14.3199L25.749 13.1662V11.3242L23.4053 12.3937V14.3199Z" fill="url(#paint1_linear_433_3347)"/>
        </g>
        </g>
        <defs>
        <linearGradient id="paint0_linear_433_3347" x1="-0.65087" y1="18.5017" x2="73.8953" y2="18.5017" gradientUnits="userSpaceOnUse">
        <stop stop-color="#009CF0"/>
        <stop offset="1" stop-color="#002E77"/>
        </linearGradient>
        <linearGradient id="paint1_linear_433_3347" x1="24.1401" y1="12.1385" x2="24.9932" y2="13.9256" gradientUnits="userSpaceOnUse">
        <stop stop-color="#1D1D1B" stop-opacity="0"/>
        <stop offset="1" stop-color="#1D1D1B" stop-opacity="0.95"/>
        </linearGradient>
        <clipPath id="clip0_433_3347">
        <rect y="0.5" width="36" height="36" rx="7" fill="white"/>
        </clipPath>
        <clipPath id="clip1_433_3347">
        <rect width="24" height="24" fill="white" transform="translate(5.99976 5.90234)"/>
        </clipPath>
        </defs>
    </svg>
    <div class="mx-3 font-weight-bold" style="font-size: 23px;line-height: 22.5px;">RoadAI</div>
</div>

<div
	class="mx-auto form-container col-xl-5 col-lg-6 col-md-7 col-sm-9"
	id="user-signup"
	data-validators="field_validators"
>
	<div class="card">
		<div class="card-body">
			<div
				class="alert alert-primary form-alert-info small"
				style="display: none"
				role="alert"
			></div>
			<div
				class="alert alert-danger form-alert-error small"
				style="display: none"
				role="alert"
			></div>
			<!-- 1. Personal Details -->
			<form
				class="form-step"
				data-step="1"
				data-action="submit_account_request"
			>
				<div class="form-group">
					<label for="subdomain">Site Name</label>
					<div class="input-group">
						<input
							type="text"
							id="subdomain"
							name="subdomain"
							class="form-control"
							placeholder="yourcompany"
							autocomplete="off"
							onchange="validate_subdomain(this)"
						/>
						<div class="input-group-append">
							<span class="input-group-text rounded-right" style="line-height: 0.5 !important;">.{{domain}}</span>
						</div>
					</div>
					<small class="form-text"></small>
				</div>

				<div class="form-row">
					<div class="form-group col-12 col-md-6">
						<label for="first_name">First Name</label>
						<input
							type="text"
							id="first_name"
							name="first_name"
							class="form-control"
							autocomplete="given-name"
						/>
					</div>
					<div class="form-group col-12 col-md-6">
						<label for="last_name">Last Name</label>
						<input
							type="text"
							id="last_name"
							name="last_name"
							class="form-control"
							autocomplete="family-name"
						/>
					</div>
				</div>
				<div class="form-group">
					<label for="email">Email address</label>
					<input
						type="email"
						id="email"
						class="form-control"
						name="email"
						autocomplete="email"
					/>
				</div>
				<div class="form-group">
					<label for="password">Password</label>
					<input
						type="password"
						id="password"
						class="form-control"
						name="password"
						onkeyup="validate_password(this)"
					/>
					<div class="mt-4 flex">
						<input
							id="showPassword"
							type="checkbox"
							onclick="togglePasswordVisibility()"
						/>
						<p class="text-xs mb-0">Show Password</p>
					</div>
				</div>
				
				<div class="form-group">
					<input
						type="checkbox"
						name="user_accept_terms"
						id="user_accept_terms"
					/>
					<label class="d-inline" for="user_accept_terms">
						By clicking on <b>Create Account</b>, you accept our
						<a href="https://frappecloud.com/terms" class="text-blue-600"
							>Terms of Service</a
						>,
						<a href="https://frappecloud.com/privacy" class="text-blue-600"
							>Privacy Policy</a
						>
						&#38;
						<a
							href="https://frappecloud.com/cookie-policy"
							class="text-blue-600"
							>Cookie Policy.</a
						>
					</label>
				</div>
				<div class="form-message text-danger"></div>
				<div class="mt-8 d-flex justify-content-between">
					<div></div>
					<button type="submit" class="btn btn-primary btn-step-1">
						Create Account
					</button>
				</div>
			</form>
			<!-- 2. Verification Email Sent -->
			<form class="form-step" data-step="2">
				<div class="text-center">
					<h2 class="font-size-base">Verification Email Sent!</h2>
					We have sent an email to <span class="verification-email"></span>.
					Please click on the link received to verify your email and create your
					account.
				</div>
			</form>
		</div>
	</div>
</div>
{%- endblock -%} {%- block script -%}
<script src="/assets/press/js/form_controller.js"></script>
<script>
	let controller;
	const app = 'roadai';

	frappe.ready(() => {
		controller = new FormController('user-signup');

		// get subdomain is set in url and show first form
		set_subdomain_from_url();
	});

	// this needs to be on global scope
	var field_validators = {
		subdomain: (value) => {
			let MIN_LENGTH = 4;
			let MAX_LENGTH = 20;
			if (value.length < MIN_LENGTH) {
				return `Site name cannot have less than ${MIN_LENGTH} characters`;
			}
			if (value.length > MAX_LENGTH) {
				return `Site name cannot have more than ${MAX_LENGTH} characters`;
			}
			if (!/^[a-z0-9][a-z0-9-]*[a-z0-9]$/.test(value)) {
				return 'Site name should contain lowercase alphabets, numbers, and hyphens';
			}
		},
		first_name: (value) => {
			if (!value) {
				return 'First Name is required';
			}
		},
		last_name: (value) => {
			if (!value) {
				return 'Last Name is required';
			}
		},
		phone_number: (value) => {
			if (!value) {
				return 'Phone Number is required';
			}

			let regExp = /[a-zA-Z]/g;
			if (regExp.test(value)) {
				return 'Phone number cannot contain alphabets';
			}
		},
		email: (value) => {
			if (!valid_email(value)) {
				return 'Invalid email';
			}
		},
		password: (value) => {
			if (!value) {
				return 'Password is required';
			} else {
				if (validate_password(value, true)) {
					return 'Please use a strong password';
				}
			}
		},
		country: (value) => {
			if (!value) {
				return 'Please enter your country name';
			}
		},
		user_accept_terms: (value) => {
			if (!value) {
				return 'You need to accept our Terms of Service & Privary Policy';
			}
		},
	};

	function submit_account_request($form, values) {
        console.log($form)
        console.log(values)
        return
		let url_args = frappe.utils.get_query_params();
		if (Object.keys(url_args)) {
			values.url_args = url_args;
		}
		values.app = app;
		return call('press.api.saas.account_request', values, $form).then(() => {
			$('h1').hide();
			$('.verification-email').text(values.email);
		});
	}

	function set_subdomain_from_url() {
		let query_params = frappe.utils.get_query_params();
		if (query_params.domain) {
            let domain = '{{domain}}';
			let subdomain = query_params.domain.replace(`.${domain}`, '');
			$('input[name="subdomain"]').val(subdomain).trigger('change');
		}
	}

	function call(method, args, $form) {
		return frappe
			.call({
				method,
				args,
				type: 'POST',
				btn: $form.find('button.btn-primary'),
			})
			.then((r) => {
				if (r.exc) {
					console.error('Có lỗi xảy ra', r.exc);
					return;
				}
				return r;
			});
	}

	function validate_subdomain(input) {
        let domain = '{{domain}}'
		let $input = $(input);
		let subdomain = $input.val();
		let error = controller.validate_value('subdomain', subdomain);
		if (error) {
			controller.show_input_error('subdomain', error);
		} else {
			check_if_available(subdomain).then((available) => {
				controller.show_input_feedback(
					'subdomain',
					!available
						? `${subdomain}.${domain} is already taken`
						: `${subdomain}.${domain} is available`,
					!available
				);
			});
		}
	}

	function validate_password(input, isValue) {
		let password;

		if (isValue) {
			password = input;
		} else {
			let $input = $(input);
			password = $input.val();
		}

		var pattern = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,}$/;

		if (password.match(pattern) && password.length >= 8) {
			controller.show_input_feedback(
				'password',
				"Now that's a strong password. Good job!",
				false
			);
			return false;
		} else {
			controller.show_input_feedback(
				'password',
				'Bad Password! The password length should be atleast 8 characters and it should contain a combination of capital letters, small letters, numbers and symbols. For e.g. Gene@31480, Merz313$oo',
				true
			);
			return true;
		}
	}

	function togglePasswordVisibility() {
		var inp = document.getElementById('password');
		if (inp.type === 'password') {
			inp.type = 'text';
		} else {
			inp.type = 'password';
		}
	}

	function check_if_available(subdomain) {
		return frappe
			.call({
				method: 'press.api.saas.check_subdomain_availability',
				args: { subdomain, app: app },
				type: 'POST',
			})
			.then((r) => {
				if (r.message) {
					return true;
				}
				return false;
			});
	}
</script>
{%- endblock -%}

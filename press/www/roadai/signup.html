{%- extends "templates/eov_signup_layout.html" -%} {%- block content -%}

<h1>Tạo tài khoản mới</h1>

<div class="mx-auto form-container col-xl-5 col-lg-6 col-md-7 col-sm-9" id="user-signup"
	data-validators="field_validators">
	<div class="card">
		<div class="card-body">
			<div class="alert alert-primary form-alert-info small" style="display: none" role="alert"></div>
			<div class="alert alert-danger form-alert-error small" style="display: none" role="alert"></div>
			<!-- 1. Personal Details -->
			<form class="form-step" data-step="1" data-action="submit_account_request">
				<div class="form-group">
					<label for="subdomain">Tên trang web</label>
					<div class="input-group">
						<input type="text" id="subdomain" name="subdomain" class="form-control"
							placeholder="Nhập tên miền" autocomplete="off" onchange="validate_subdomain(this)" />
						<div class="input-group-append">
							<span class="input-group-text rounded-right"
								style="line-height: 0.5 !important;">.{{domain}}</span>
						</div>
					</div>
					<small class="form-text"></small>
				</div>

				<div class="form-group">
					<label for="first_name">Họ và tên</label>
					<input type="text" id="first_name" name="first_name" class="form-control"
						autocomplete="given-name" />
				</div>
				<!-- <div class="form-row">
					<div class="form-group col-12 col-md-6">
						<label for="first_name">Họ</label>
						<input type="text" id="first_name" name="first_name" class="form-control"
							autocomplete="given-name" />
					</div>
					<div class="form-group col-12 col-md-6">
						<label for="last_name">Tên</label>
						<input type="text" id="last_name" name="last_name" class="form-control"
							autocomplete="family-name" />
					</div>
				</div> -->
				<div class="form-group">
					<label for="phone">Số điện thoại</label>
					<input type="tel" id="phone" class="form-control" name="phone_number" autocomplete="tel" />
				</div>
				<div class="form-group">
					<label for="email">Địa chỉ Email</label>
					<input type="email" id="email" class="form-control" name="email" autocomplete="email" />
				</div>
				<!-- <div class="form-group">
					<label for="country">Quốc Gia</label>
					<select id="country" class="custom-select" name="country">
						{%- if country_name -%}
						<option selected="selected">{{ country_name }}</option>
						{%- else -%}
						<option disabled selected="selected">Chọn quốc gia</option>
						{%- endif -%}
						{%- for country in frappe.db.get_all('Country') -%}
						<option>
							{{ country.name }}
						</option>
						{%- endfor -%}
					</select>
				</div> -->
				<div class="form-group">
					<label for="password">Mật khẩu</label>
					<input type="password" id="password" class="form-control" name="password"
						onkeyup="validate_password(this)" />
				</div>
				<div class="form-group">
					<input id="showPassword" type="checkbox" onclick="togglePasswordVisibility()" />
					<label for="showPassword" class="text-xs mb-0">Hiện mật khẩu</label>
				</div>

				<div class="form-group">
					<input type="checkbox" name="user_accept_terms" id="user_accept_terms" />
					<label class="d-inline" for="user_accept_terms">
						Bằng cách chọn <b>Tạo tài khoản</b>, bạn sẽ chấp nhận
						<a href="https://frappecloud.com/terms" class="text-blue-600">Điều khoản dịch vụ</a>,
						<a href="https://frappecloud.com/privacy" class="text-blue-600">Chính sách quyền riêng tư</a>
						&#38;
						<a href="https://frappecloud.com/cookie-policy" class="text-blue-600">Chính sách cookie</a> của
						chúng tôi.
					</label>
				</div>
				<div class="form-message text-danger"></div>
				<div class="mt-8 d-flex justify-content-between">
					<div></div>
					<button type="submit" class="btn btn-primary btn-step-1">
						Tạo tài khoản
					</button>
				</div>
			</form>
			<!-- 2. Verification Email Sent -->
			<form class="form-step" data-step="2">
				<div class="text-center">
					<h2 class="font-size-base">Email xác minh đã được gửi!</h2>
					Chúng tôi đã gửi một email xác thực đến <span class="verification-email"></span>.
					Vui lòng nhấp vào liên kết nhận được để xác minh email, tạo tài khoản và trang web của bạn.
				</div>
			</form>
		</div>
	</div>
</div>
{%- endblock -%} {%- block script -%}
<script src="/assets/press/js/form_controller.js"></script>
<script>
	let controller;
	const app = 'roadai';

	frappe.ready(() => {
		controller = new FormController('user-signup');

		// get subdomain is set in url and show first form
		set_subdomain_from_url();
	});

	// this needs to be on global scope
	var field_validators = {
		subdomain: (value) => {
			let MIN_LENGTH = 4;
			let MAX_LENGTH = 20;
			if (value.length < MIN_LENGTH) {
				return `Tên trang web không thể có ít hơn ${MIN_LENGTH} kí tự.`;
			}
			if (value.length > MAX_LENGTH) {
				return `Tên trang web không thể có nhiều hơn ${MAX_LENGTH} kí tự.`;
			}
			if (!/^[a-z0-9][a-z0-9-]*[a-z0-9]$/.test(value)) {
				return 'Tên trang web phải chứa chữ cái viết thường, số và dấu gạch nối.';
			}
		},
		first_name: (value) => {
			if (!value) {
				return 'Trường bắt buộc.';
			}
		},
		// last_name: (value) => {
		// 	if (!value) {
		// 		return 'Trường bắt buộc';
		// 	}
		// },
		phone_number: (value) => {
			if (!value) {
				return 'Trường Số điện thoại là bắt buộc.';
			}

			let regExp = /[a-zA-Z]/g;
			if (regExp.test(value)) {
				return 'Số điện thoại không thể chứa bảng chữ cái.';
			}
		},
		email: (value) => {
			if (!valid_email(value)) {
				return 'Email không hợp lệ.';
			}
		},
		password: (value) => {
			if (!value) {
				return 'Vui lòng điền mật khẩu.';
			} else {
				if (validate_password(value, true)) {
					return 'Vui lòng sử dụng mật khẩu mạnh hơn.';
				}
			}
		},
		// country: (value) => {
		// 	if (!value) {
		// 		return 'Vui lòng điền tên Quốc Gia của bạn.';
		// 	}
		// },
		user_accept_terms: (value) => {
			if (!value) {
				return 'Bạn cần chấp nhận chính sách của chúng tôi.';
			}
		},
	};

	function submit_account_request($form, values) {
		let url_args = frappe.utils.get_query_params();
		if (Object.keys(url_args)) {
			values.url_args = url_args;
		}
		values.app = app;
		return call('press.api.saas.account_request', values, $form).then(() => {
			$('h1').hide();
			$('.verification-email').text(values.email);
		});
	}

	function set_subdomain_from_url() {
		let query_params = frappe.utils.get_query_params();
		if (query_params.domain) {
			let domain = '{{domain}}';
			let subdomain = query_params.domain.replace(`.${domain}`, '');
			$('input[name="subdomain"]').val(subdomain).trigger('change');
		}
	}

	function call(method, args, $form) {
		return frappe
			.call({
				method,
				args,
				type: 'POST',
				btn: $form.find('button.btn-primary'),
			})
			.then((r) => {
				if (r.exc) {
					console.error('Có lỗi xảy ra', r.exc);
					return;
				}
				return r;
			});
	}

	function validate_subdomain(input) {
		let domain = '{{domain}}'
		let $input = $(input);
		let subdomain = $input.val();
		let error = controller.validate_value('subdomain', subdomain);
		if (error) {
			controller.show_input_error('subdomain', error);
		} else {
			check_if_available(subdomain).then((available) => {
				controller.show_input_feedback(
					'subdomain',
					!available
						? `${subdomain}.${domain} đã được sử dụng.`
						: `${subdomain}.${domain} không hợp lệ.`,
					!available
				);
			});
		}
	}

	function validate_password(input, isValue) {
		let password;

		if (isValue) {
			password = input;
		} else {
			let $input = $(input);
			password = $input.val();
		}

		var pattern = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,}$/;

		if (password.match(pattern) && password.length >= 8) {
			controller.show_input_feedback(
				'password',
				"Bạn đã sử dụng mật khẩu mạnh.",
				false
			);
			return false;
		} else {
			controller.show_input_feedback(
				'password',
				'Mật khẩu yếu! Độ dài mật khẩu phải có ít nhất 8 ký tự và phải chứa sự kết hợp của chữ in hoa, chữ thường, số và ký hiệu. Ví dụ: Gene@31480, Merz313$oo',
				true
			);
			return true;
		}
	}

	function togglePasswordVisibility() {
		var inp = document.getElementById('password');
		if (inp.type === 'password') {
			inp.type = 'text';
		} else {
			inp.type = 'password';
		}
	}

	function check_if_available(subdomain) {
		return frappe
			.call({
				method: 'press.api.saas.check_subdomain_availability',
				args: { subdomain, app: app },
				type: 'POST',
			})
			.then((r) => {
				if (r.message) {
					return true;
				}
				return false;
			});
	}
</script>
{%- endblock -%}